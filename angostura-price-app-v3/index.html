<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Angostura Price List — Nov 9, 2025</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    :root { --bg:#0f1115; --card:#151822; --muted:#9aa4b2; --text:#e6eaf2; --accent:#58a6ff; --chip:#1e2330; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(15,17,21,.95),rgba(15,17,21,.75) 70%,rgba(15,17,21,0));backdrop-filter:blur(8px);}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0 0 8px;font-weight:600;font-size:20px}
    .bar{display:grid;gap:8px;grid-template-columns:1fr; padding:8px 0}
    @media(min-width:900px){ .bar{grid-template-columns: 1fr 1fr 1fr 1fr auto} }
    select,input,button{width:100%;padding:10px 12px;background:var(--card);border:1px solid #293142;color:var(--text);border-radius:10px;outline:none}
    select:focus,input:focus{border-color:var(--accent)}
    button{cursor:pointer;background:#1f6feb;border-color:#1f6feb}
    button.secondary{background:var(--card);border-color:#293142}
    .card{background:var(--card);border:1px solid #222a39;border-radius:14px;padding:12px;margin-top:12px}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    table.dataTable thead th{position:sticky;top:0;background:var(--card);}
    table.dataTable{width:100%!important;border-collapse:separate;border-spacing:0;border-radius:12px;overflow:hidden}
    #error{display:none;background:#2a1b1b;border:1px solid #5c2b2b;color:#ffb4b4;padding:10px;border-radius:10px;margin:12px 0}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Angostura Price List — Nov 9, 2025</h1>
      <div id="error"></div>
      <div class="bar">
        <input id="globalSearch" type="search" placeholder="Search all columns (brand, code, UPC…)" />
        <select id="categoryFilter"><option value="">All Categories</option></select>
        <select id="subcategoryFilter"><option value="">All Subcategories</option></select>
        <div style="display:flex;gap:8px">
          <input id="minPrice" type="number" step="0.01" placeholder="Min MSRP" />
          <input id="maxPrice" type="number" step="0.01" placeholder="Max MSRP" />
        </div>
        <div style="display:flex; gap:8px;">
          <button id="resetFilters" class="secondary">Reset</button>
          <button id="downloadView">Export View (CSV)</button>
        </div>
      </div>
      <div class="hint">If you see a column warning, hard refresh (⌘⇧R). We normalize columns automatically.</div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <table id="priceTable" class="display" style="width:100%"></table>
    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const CSV_PATH = 'angostura-price-list-2025-11-09.csv';
    let table, headers = [], rows = [];

    const showError = (msg) => {
      const el = document.getElementById('error');
      el.style.display = 'block';
      el.textContent = msg;
    };

    const norm = s => (s ?? '').toString().trim();
    const normLower = s => norm(s).toLowerCase();
    const uniqueSorted = list => Array.from(new Set(list.filter(Boolean))).sort((a,b)=>a.localeCompare(b));

    function detectMaxColumns(data){
      let max = 0;
      data.forEach(r => { if (r.length > max) max = r.length; });
      return max;
    }

    function normalizeTableData(data){
      // 1) Drop trailing blank rows
      const filtered = data.filter(r => r && r.some(x => norm(x) !== ''));
      // 2) Compute max col count and pad/trim
      const maxCols = detectMaxColumns(filtered);
      const uniform = filtered.map(r => {
        const row = r.slice(0, maxCols);
        while (row.length < maxCols) row.push('');
        return row;
      });
      return uniform;
    }

    function findHeaderIdx(nameLike){
      const exact = headers.findIndex(h => normLower(h) === normLower(nameLike));
      if (exact >= 0) return exact;
      const inc = headers.findIndex(h => normLower(h).includes(normLower(nameLike)));
      return inc >= 0 ? inc : -1;
    }

    function exportViewCSV() {
      const data = table.rows({search:'applied'}).data().toArray();
      const lines = [headers.join(',')];
      data.forEach(row => {
        const safe = row.map(v => {
          const s = (v ?? '').toString().replace(/"/g,'""');
          return /[",\n]/.test(s) ? '"' + s + '"' : s;
        });
        lines.push(safe.join(','));
      });
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'angostura-price-list-view.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function buildTable(matrix){
      // Normalize dimensions
      const uniform = normalizeTableData(matrix);
      headers = uniform[0].map(h => norm(h));
      rows = uniform.slice(1);

      // Build HTML
      const thead = '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
      const tbody = '<tbody>' + rows.map(r => '<tr>' + r.map(c => `<td>${norm(c)}</td>`).join('') + '</tr>').join('') + '</tbody>';
      document.getElementById('priceTable').innerHTML = thead + tbody;

      // Init DataTable
      table = new $.fn.dataTable.Api($('#priceTable').DataTable({
        pageLength: 25,
        stateSave: true,
        autoWidth: false,
        deferRender: true
      }));

      initFilters();
    }

    function initFilters(){
      const catIdx = findHeaderIdx('Category');
      const subIdx = findHeaderIdx('Subcategory');
      const msrpIdx = findHeaderIdx('MSRP'); // partial match ok

      // Populate dropdowns
      if (catIdx >= 0){
        const cats = uniqueSorted(rows.map(r => r[catIdx]));
        const catSel = document.getElementById('categoryFilter');
        cats.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o); });
        catSel.addEventListener('change', ()=>{
          const val = catSel.value ? '^' + $.fn.dataTable.util.escapeRegex(catSel.value) + '$' : '';
          table.column(catIdx).search(val, true, false).draw();
        });
      }

      if (subIdx >= 0){
        const subs = uniqueSorted(rows.map(r => r[subIdx]));
        const subSel = document.getElementById('subcategoryFilter');
        subs.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; subSel.appendChild(o); });
        subSel.addEventListener('change', ()=>{
          const val = subSel.value ? '^' + $.fn.dataTable.util.escapeRegex(subSel.value) + '$' : '';
          table.column(subIdx).search(val, true, false).draw();
        });
      }

      // Price range
      const minI = document.getElementById('minPrice');
      const maxI = document.getElementById('maxPrice');
      if (msrpIdx >= 0){
        $.fn.dataTable.ext.search.push(function(settings, data){
          const min = parseFloat(minI.value);
          const max = parseFloat(maxI.value);
          const val = parseFloat((data[msrpIdx] || '').toString().replace(/[^0-9.]/g,''));
          if (isNaN(val)) return true;
          if (!isNaN(min) && val < min) return false;
          if (!isNaN(max) && val > max) return false;
          return true;
        });
        minI.addEventListener('input', ()=>table.draw());
        maxI.addEventListener('input', ()=>table.draw());
      }

      document.getElementById('resetFilters').addEventListener('click', ()=>{
        document.getElementById('globalSearch').value='';
        if (catIdx >= 0) document.getElementById('categoryFilter').value='';
        if (subIdx >= 0) document.getElementById('subcategoryFilter').value='';
        minI.value=''; maxI.value='';
        table.search(''); table.columns().search(''); table.draw();
      });

      document.getElementById('globalSearch').addEventListener('input', (e)=>{
        table.search(e.target.value).draw();
      });

      document.getElementById('downloadView').addEventListener('click', exportViewCSV);
    }

    Papa.parse(CSV_PATH, {
      download: true,
      dynamicTyping: false,
      skipEmptyLines: 'greedy',
      complete: function(results){
        try{
          if (!results || !results.data || results.data.length === 0) {
            showError('Could not load data. Make sure the CSV is present.');
            return;
          }
          buildTable(results.data);
        }catch(e){
          console.error(e);
          showError('Unexpected error while building the table.');
        }
      },
      error: function(err){
        console.error(err);
        showError('Failed to fetch the CSV file.');
      }
    });
  </script>
</body>
</html>
